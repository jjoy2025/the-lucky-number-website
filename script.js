const SUPABASE_URL="https://urjcuxavrkyqttwtqvjx.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ",supabase=window.supabase.createClient("https://urjcuxavrkyqttwtqvjx.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ");document.addEventListener("DOMContentLoaded",()=>{window.location.pathname.endsWith("admin.html")?setupAdminPanel():window.location.pathname.endsWith("dealer-dashboard.html")?setupDealerDashboard():setupPublicWebsite()});function setupPublicWebsite(){fetchTodayResults(),fetchOldResults(),setupLoginButton(),startLiveAnimation(),supabase.channel("results_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"results"},a=>{console.log("New result added:",a.new),fetchTodayResults()}).subscribe()}async function setupAdminPanel(){async function h(){const{data:a,error:b}=await supabase.from("dealers").select("*");return b?void console.error("Failed to load dealers:",b.message):void(z.innerHTML="<option value=\"\">Select Dealer</option>",a.forEach(a=>{const b=document.createElement("option");b.value=a.id,b.textContent=`${a.name} (${a.token_balance||0} tokens)`,z.appendChild(b)}))}async function i(){const{data:a,error:b}=await supabase.from("dealers").select("id, name");return b?void console.error("Failed to load dealers for report:",b.message):void(A.innerHTML="<option value=\"\">Select Dealer</option>",a.forEach(a=>{const b=document.createElement("option");b.value=a.id,b.textContent=a.name,A.appendChild(b)}))}async function f(f,e){const{data:a,error:b}=await supabase.from("plays").select("*").eq("dealer_id",f).eq("play_date",e);if(b||!a||0===a.length)return void(C.innerHTML="<p>No report found for this date.</p>");const{data:c}=await supabase.from("results").select("*").eq("date",e);C.innerHTML=`<h2>Report for ${e}</h2>`,C.innerHTML+="<table border=\"1\" style=\"width:100%; text-align:center;\">",C.innerHTML+="<thead><tr><th>Time</th><th>Played Numbers</th><th>Winning Number</th><th>Spent</th><th>Prize</th><th>Profit/Loss</th></tr></thead>",C.innerHTML+="<tbody>";let d=0,j=0;a.forEach(g=>{const i=c.find(a=>a.slot_id===g.baji_slot),f=i?i.single_number:"-",e=Object.keys(g.played_numbers).map(a=>`${a}(${g.played_numbers[a]})`).join(", "),h="-"!==f&&g.played_numbers[f]?90*g.played_numbers[f]:0,a=h-g.total_spent_tokens;d+=g.total_spent_tokens,j+=h,C.innerHTML+=`
                <tr>
                    <td>${g.play_time}</td>
                    <td>${e}</td>
                    <td>${f}</td>
                    <td>${g.total_spent_tokens}</td>
                    <td>${h}</td>
                    <td>${a}</td>
                </tr>
            `}),C.innerHTML+=`
            <tr>
                <td colspan="3">Total</td>
                <td>${d}</td>
                <td>${j}</td>
                <td>${j-d}</td>
            </tr>
        `,C.innerHTML+="</tbody></table>",D.innerHTML=""}async function g(c){const{data:d,error:e}=await supabase.from("plays").select("played_numbers").eq("play_date",c);if(e||!d||0===d.length)return D.innerHTML="<p>No data found for this date.</p>",void(E&&E.destroy());const f={};d.forEach(a=>{for(const b in a.played_numbers){const c=a.played_numbers[b];f[b]?f[b]+=c:f[b]=c}});const g=Object.keys(f).sort((c,a)=>c-a),h=g.map(a=>f[a]);E&&E.destroy();const a=document.getElementById("myChart").getContext("2d");E=new Chart(a,{type:"bar",data:{labels:g,datasets:[{label:"Most tokens placed on",data:h,backgroundColor:"rgba(243, 156, 18, 0.7)",borderColor:"rgba(243, 156, 18, 1)",borderWidth:1}]},options:{responsive:!0,scales:{x:{title:{display:!0,text:"Number"}},y:{beginAtZero:!0,title:{display:!0,text:"Tokens"}}}}}),C.innerHTML=""}const{data:{session:k},error:j}=await supabase.auth.getSession(),l=document.getElementById("common-login-form"),m=document.getElementById("login-section"),n=document.getElementById("data-entry-section"),o=document.getElementById("logout-btn"),p=document.getElementById("auth-error"),q=document.getElementById("result-form"),r=document.getElementById("dealer-form"),s=document.getElementById("token-transfer-form"),t=document.getElementById("baji-select"),u=document.querySelectorAll(".tab-button"),v=document.querySelectorAll(".tab-content"),w=document.getElementById("result-message"),x=document.getElementById("dealer-message"),y=document.getElementById("token-message"),z=document.getElementById("dealer-select"),A=document.getElementById("report-dealer-select"),B=document.getElementById("report-date-input"),d=document.getElementById("showReportBtn"),a=document.getElementById("showGraphBtn"),C=document.getElementById("reportContainer"),D=document.getElementById("graphContainer"),b=document.getElementById("archive-btn"),c=document.getElementById("archive-message");let E=null;(function a(){t.innerHTML="";for(let a=1;8>=a;a++){const b=document.createElement("option");b.value=a,b.textContent=`Baji ${a}`,t.appendChild(b)}})(),k?(m.style.display="none",n.style.display="block",o.style.display="block",await h(),await i()):(m.style.display="block",n.style.display="none",o.style.display="none"),u.forEach(a=>{a.addEventListener("click",()=>{u.forEach(a=>a.classList.remove("active")),v.forEach(a=>a.classList.remove("active")),a.classList.add("active");const b=a.dataset.tab;document.getElementById(b).classList.add("active"),E&&(E.destroy(),E=null)})}),l.addEventListener("submit",async a=>{a.preventDefault();const b=document.getElementById("email-input").value,c=document.getElementById("password-input").value;p.textContent="";const{data:d,error:e}=await supabase.auth.signInWithPassword({email:b,password:c});if(e)return void(p.textContent="Login failed: "+e.message);const{data:{user:f}}=await supabase.auth.getUser();if(f){const{data:a,error:b}=await supabase.from("dealers").select("id").eq("user_id",f.id).single();window.location.href=a?`dealer-dashboard.html?dealerId=${a.id}`:"admin.html"}}),q.addEventListener("submit",async e=>{e.preventDefault();const f=document.getElementById("date-input").value,g=parseInt(t.value),h=document.getElementById("patti-input").value,a=parseInt(document.getElementById("single-input").value),b=new Date().toISOString().split("T")[0];let c=null;c=f===b?"results":"old_results";const{error:i}=await supabase.from(c).upsert({date:f,slot_id:g,patti_number:h,single_number:a});i?(w.textContent="Failed to save result: "+i.message,w.style.color="red"):(w.textContent="Result saved successfully!",w.style.color="green",q.reset(),f===b?fetchTodayResults():fetchOldResults())}),r.addEventListener("submit",async a=>{a.preventDefault();const c=document.getElementById("dealer-name").value,g=document.getElementById("dealer-phone").value,d=document.getElementById("dealer-password").value,e=document.getElementById("dealer-message");e.textContent="Adding dealer...",e.className="message";try{const{error:a}=await supabase.rpc("create_dealer",{dealer_name:c,dealer_phone:g,dealer_password:d});if(a)throw a;e.textContent="Dealer added successfully!",e.className="message success-message",document.getElementById("dealer-form").reset(),await h(),await i()}catch(a){e.textContent=`Failed to add dealer: ${a.message}`,e.className="message error-message",console.error("Error adding dealer:",a)}}),s.addEventListener("submit",async b=>{b.preventDefault();const c=document.getElementById("dealer-select").value,d=parseInt(document.getElementById("token-amount").value);if(!c||isNaN(d)||0>=d)return y.textContent="Please enter a valid amount and select a dealer.",void(y.style.color="red");const{data:e,error:f}=await supabase.rpc("transfer_tokens_secure",{dealer_id_in:c,amount_in:d});f?(y.textContent="Failed to transfer tokens: "+f.message,y.style.color="red",console.error("Database function call failed:",f)):(y.textContent="Tokens transferred successfully!",y.style.color="green",s.reset(),await h())}),b&&b.addEventListener("click",async()=>{c.textContent="Archiving...";const{error:a}=await supabase.rpc("archive_daily_results");a?(c.textContent="Archiving failed: "+a.message,c.style.color="red"):(c.textContent="Previous day's results archived successfully!",c.style.color="green",fetchTodayResults(),fetchOldResults())}),d.addEventListener("click",()=>{const a=A.value,b=B.value;a&&b?f(a,b):alert("Please select a dealer and a date.")}),a.addEventListener("click",()=>{const b=B.value;b?g(b):alert("Please select a date.")}),o.addEventListener("click",async()=>{const{error:a}=await supabase.auth.signOut();window.location.reload()})}async function setupDealerDashboard(){const{data:{session:a},error:d}=await supabase.auth.getSession();if(!a)return void(window.location.href="admin.html");const b=document.getElementById("dealer-name-display"),j=document.getElementById("current-token-balance"),e=document.getElementById("logout-btn"),l=document.getElementById("betting-form"),n=document.getElementById("bet-number"),m=document.getElementById("bet-amount"),k=document.getElementById("bet-message"),o=document.getElementById("slips-container"),p=document.getElementById("baji-select"),i=document.getElementById("betting-closed-message"),{data:f,error:g}=await supabase.from("dealers").select("id, name").eq("user_id",a.user.id).single();if(f){async function q(){const{data:b,error:c}=await supabase.from("dealers").select("token_balance").eq("id",d).single();b?j.textContent=`Your Token Balance: ${b.token_balance||0} tokens`:console.error("Failed to fetch dealer balance:",c.message)}async function c(){const a=[{id:1,time:"11:00 AM",hour:11,minute:0},{id:2,time:"12:30 PM",hour:12,minute:30},{id:3,time:"2:00 PM",hour:14,minute:0},{id:4,time:"3:30 PM",hour:15,minute:30},{id:5,time:"5:00 PM",hour:17,minute:0},{id:6,time:"6:30 PM",hour:18,minute:30},{id:7,time:"8:00 PM",hour:20,minute:0},{id:8,time:"9:00 PM",hour:21,minute:0}];p.innerHTML="";const f=new Date,e=[];if(a.forEach(a=>{const c=new Date(f.getFullYear(),f.getMonth(),f.getDate(),a.hour,a.minute);c>f&&e.push({...a,date:f})}),0===e.length){const c=new Date(f);c.setDate(f.getDate()+1),e.push({...a[0],date:c})}const c=e.find(a=>{const c=new Date(a.date.getFullYear(),a.date.getMonth(),a.date.getDate(),a.hour,a.minute),b=(c.getTime()-f.getTime())/6e4;return 20<b});if(c){const d=document.createElement("option");d.value=c.id;const b=c.date.getDate()!==f.getDate(),e=b?" (Tomorrow)":"";d.textContent=`${c.id}th Baji - ${c.time}${e}`,p.appendChild(d),l.style.display="block",i.style.display="none"}else l.style.display="none",i.style.display="block"}async function r(d){const e=new Date().toISOString().split("T")[0],{data:a,error:b}=await supabase.from("plays").select("*").eq("dealer_id",d).eq("play_date",e).order("baji_slot",{ascending:!0});if(b||!a||0===a.length)return void(o.innerHTML="<p style=\"text-align: center;\">No bets placed today.</p>");const{data:l}=await supabase.from("results").select("*").eq("date",e);o.innerHTML="",a.forEach(e=>{const a=document.createElement("div");a.className="admin-section";const b=l.find(a=>a.slot_id===e.baji_slot),c=b?b.single_number:"-",d=Object.keys(e.played_numbers)[0],f=e.played_numbers[d],g="-"!==c&&parseInt(d)===c,h=g?90*f:0,i=g?"green":"red",k=g?"Congratulations, you won!":"Sorry, you lost.";a.innerHTML=`
                    <h3>${e.baji_slot}th Baji - ${e.play_time}</h3>
                    <p><strong>Your Number:</strong> ${d} (Tokens: ${f})</p>
                    <p><strong>Winning Number:</strong> ${c}</p>
                    <p style="color: ${i}; font-weight: bold;">${k}</p>
                    <p><strong>Prize Tokens:</strong> ${h}</p>
                `,o.appendChild(a)})}b.textContent=`Welcome, ${f.name}!`;const d=f.id;e.addEventListener("click",async()=>{const{error:a}=await supabase.auth.signOut();window.location.href="admin.html"}),l.addEventListener("submit",async b=>{b.preventDefault();const c=parseInt(p.value),e=parseInt(n.value),f=parseInt(m.value);if(isNaN(e)||0>e||9<e||isNaN(f)||0>=f)return k.textContent="Please enter a valid number (0-9) and amount.",void(k.style.color="red");const{error:g}=await supabase.rpc("place_bet",{dealer_id_in:d,baji_slot_in:c,bet_number_in:e.toString(),bet_amount_in:f});return g?(k.textContent="Failed to place bet: "+g.message,void(k.style.color="red")):void(k.textContent="Bet placed successfully!",k.style.color="green",l.reset(),await q(),await r(d))}),q(),c(),r(d),setInterval(()=>{q(),r(d),c()},5e3)}else b.textContent=`Error! Dealer not found.`,console.error("Failed to fetch dealer name:",g.message)}function setupLoginButton(){const a=document.getElementById("login-link");a&&(a.href="admin.html")}async function fetchTodayResults(){const a=new Date().toISOString().split("T")[0],{data:b,error:c}=await supabase.from("results").select("*").eq("date",a).order("slot_id",{ascending:!0});if(c)return void console.error("Error fetching today's results:",c.message);const i=document.querySelector(".today-result .results-grid");i.innerHTML="";const g=new Map;b.forEach(a=>{g.set(a.slot_id,a)});for(let a=1;8>=a;a++){const b=g.get(a),c=b?b.patti_number:"- - -",d=b?b.single_number:"-",e=document.createElement("div");e.className="result-box-item",e.innerHTML=`
            <div class="patti">${c}</div>
            <div class="single">${d}</div>
        `,i.appendChild(e)}document.getElementById("current-date").textContent=new Date().toLocaleDateString("en-US")}async function fetchOldResults(){const{data:a,error:b}=await supabase.from("old_results").select("*").order("date",{ascending:!1}).limit(100);if(b)return void console.error("Error fetching old results:",b.message);const d=a.reduce((a,b)=>{const c=b.date;return a[c]||(a[c]=[]),a[c].push(b),a},{}),e=document.querySelector(".old-results-container");for(const a in e.innerHTML="",d){const b=document.createElement("div");b.className="old-results-day",b.innerHTML=`
            <div class="result-date">${new Date(a).toLocaleDateString("en-US")}</div>
            <div class="results-grid"></div>
        `,e.appendChild(b);const g=b.querySelector(".results-grid"),i=d[a].sort((c,a)=>c.slot_id-a.slot_id);for(let a=1;8>=a;a++){const b=i.find(b=>b.slot_id===a),c=b?b.patti_number:"- - -",d=b?b.single_number:"-",e=document.createElement("div");e.className="result-box-item",e.innerHTML=`
                <div class="patti">${c}</div>
                <div class="single">${d}</div>
            `,g.appendChild(e)}}}function startLiveAnimation(){const a=document.querySelector(".today-result .date-header");a.classList.add("live-animation")}