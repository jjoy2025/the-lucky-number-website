const SUPABASE_URL="https://urjcuxavrkyqttwtqvjx.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ",supabase=window.supabase.createClient("https://urjcuxavrkyqttwtqvjx.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ");document.addEventListener("DOMContentLoaded",()=>{window.location.pathname.endsWith("admin.html")?setupAdminPanel():window.location.pathname.endsWith("dealer-dashboard.html")?setupDealerDashboard():setupPublicWebsite()});function setupPublicWebsite(){fetchTodayResults(),fetchOldResults(),setupLoginButton(),startLiveAnimation(),supabase.channel("results_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"results"},a=>{console.log("New result added:",a.new),fetchTodayResults()}).subscribe()}async function setupAdminPanel(){async function k(){const{data:c,error:a}=await supabase.from("dealers").select("*");return a?void console.error("Failed to load dealers:",a.message):void(E.innerHTML="<option value=\"\">Select Dealer</option>",c.forEach(c=>{const a=document.createElement("option");a.value=c.id,a.textContent=`${c.name} (${c.token_balance||0} tokens)`,E.appendChild(a)}))}async function m(){const{data:c,error:a}=await supabase.from("dealers").select("id, name");return a?void console.error("Failed to load dealers for report:",a.message):void(d.innerHTML="<option value=\"\">Select Dealer</option>",c.forEach(c=>{const a=document.createElement("option");a.value=c.id,a.textContent=c.name,d.appendChild(a)}))}async function n(a,b){const{data:c,error:d}=await supabase.from("plays").select("*").eq("dealer_id",a).eq("play_date",b);if(d||!c||0===c.length)return void(F.innerHTML="<p>No report found for this date.</p>");const{data:g}=await supabase.from("results").select("*").eq("date",b);F.innerHTML=`<h2>Report for ${b}</h2>`,F.innerHTML+="<table border=\"1\" style=\"width:100%; text-align:center;\">",F.innerHTML+="<thead><tr><th>Time</th><th>Played Numbers</th><th>Winning Number</th><th>Spent</th><th>Prize</th><th>Profit/Loss</th></tr></thead>",F.innerHTML+="<tbody>";let i=0,j=0;c.forEach(f=>{const e=g.find(a=>a.slot_id===f.baji_slot),h=e?e.single_number:"-",a=Object.keys(f.played_numbers).map(a=>`${a}(${f.played_numbers[a]})`).join(", "),b="-"!==h&&f.played_numbers[h]?90*f.played_numbers[h]:0,c=b-f.total_spent_tokens;i+=f.total_spent_tokens,j+=b,F.innerHTML+=`
                <tr>
                    <td>${f.play_time}</td>
                    <td>${a}</td>
                    <td>${h}</td>
                    <td>${f.total_spent_tokens}</td>
                    <td>${b}</td>
                    <td>${c}</td>
                </tr>
            `}),F.innerHTML+=`
            <tr>
                <td colspan="3">Total</td>
                <td>${i}</td>
                <td>${j}</td>
                <td>${j-i}</td>
            </tr>
        `,F.innerHTML+="</tbody></table>",G.innerHTML=""}async function o(e){const{data:f,error:g}=await supabase.from("plays").select("played_numbers").eq("play_date",e);if(g||!f||0===f.length)return G.innerHTML="<p>No data found for this date.</p>",void(h&&h.destroy());const j={};f.forEach(c=>{for(const d in c.played_numbers){const a=c.played_numbers[d];j[d]?j[d]+=a:j[d]=a}});const a=Object.keys(j).sort((b,c)=>b-c),b=a.map(a=>j[a]);h&&h.destroy();const c=document.getElementById("myChart").getContext("2d");h=new Chart(c,{type:"bar",data:{labels:a,datasets:[{label:"Most tokens placed on",data:b,backgroundColor:"rgba(243, 156, 18, 0.7)",borderColor:"rgba(243, 156, 18, 1)",borderWidth:1}]},options:{responsive:!0,scales:{x:{title:{display:!0,text:"Number"}},y:{beginAtZero:!0,title:{display:!0,text:"Tokens"}}}}}),F.innerHTML=""}const{data:{session:q},error:p}=await supabase.auth.getSession(),r=document.getElementById("common-login-form"),s=document.getElementById("login-section"),t=document.getElementById("data-entry-section"),u=document.getElementById("logout-btn"),v=document.getElementById("auth-error"),w=document.getElementById("result-form"),x=document.getElementById("dealer-form"),y=document.getElementById("token-transfer-form"),z=document.getElementById("baji-select"),A=document.querySelectorAll(".tab-button"),B=document.querySelectorAll(".tab-content"),C=document.getElementById("result-message"),a=document.getElementById("dealer-message"),D=document.getElementById("token-message"),E=document.getElementById("dealer-select"),d=document.getElementById("report-dealer-select"),e=document.getElementById("report-date-input"),b=document.getElementById("showReportBtn"),c=document.getElementById("showGraphBtn"),F=document.getElementById("reportContainer"),G=document.getElementById("graphContainer"),f=document.getElementById("archive-btn"),g=document.getElementById("archive-message");let h=null;(function a(){z.innerHTML="";for(let c=1;8>=c;c++){const a=document.createElement("option");a.value=c,a.textContent=`Baji ${c}`,z.appendChild(a)}})(),q?(s.style.display="none",t.style.display="block",u.style.display="block",await k(),await m()):(s.style.display="block",t.style.display="none",u.style.display="none"),A.forEach(c=>{c.addEventListener("click",()=>{A.forEach(a=>a.classList.remove("active")),B.forEach(a=>a.classList.remove("active")),c.classList.add("active");const a=c.dataset.tab;document.getElementById(a).classList.add("active"),h&&(h.destroy(),h=null)})}),r.addEventListener("submit",async c=>{c.preventDefault();const d=document.getElementById("email-input").value,e=document.getElementById("password-input").value;v.textContent="";const{data:f,error:a}=await supabase.auth.signInWithPassword({email:d,password:e});if(a)return void(v.textContent="Login failed: "+a.message);const{data:{user:g}}=await supabase.auth.getUser();if(g){const{data:c,error:a}=await supabase.from("dealers").select("id").eq("user_id",g.id).single();window.location.href=c?`dealer-dashboard.html?dealerId=${c.id}`:"admin.html"}}),w.addEventListener("submit",async g=>{g.preventDefault();const h=document.getElementById("date-input").value,a=parseInt(z.value),b=document.getElementById("patti-input").value,c=parseInt(document.getElementById("single-input").value),d=new Date().toISOString().split("T")[0];let e=null;e=h===d?"results":"old_results";const{error:i}=await supabase.from(e).upsert({date:h,slot_id:a,patti_number:b,single_number:c});i?(C.textContent="Failed to save result: "+i.message,C.style.color="red"):(C.textContent="Result saved successfully!",C.style.color="green",w.reset(),h===d?fetchTodayResults():fetchOldResults())}),x.addEventListener("submit",async a=>{a.preventDefault();const d=document.getElementById("dealer-name").value,e=document.getElementById("dealer-phone").value,f=document.getElementById("dealer-password").value,c=document.getElementById("dealer-message");c.textContent="Adding dealer...",c.className="message";try{const{error:a}=await supabase.rpc("create_dealer",{dealer_name:d,dealer_phone:e,dealer_password:f});if(a)throw a;c.textContent="Dealer added successfully!",c.className="message success-message",document.getElementById("dealer-form").reset(),await k(),await m()}catch(a){c.textContent=`Failed to add dealer: ${a.message}`,c.className="message error-message",console.error("Error adding dealer:",a)}}),y.addEventListener("submit",async d=>{d.preventDefault();const e=document.getElementById("dealer-select").value,f=parseInt(document.getElementById("token-amount").value);if(!e||isNaN(f)||0>=f)return D.textContent="Please enter a valid amount and select a dealer.",void(D.style.color="red");const{data:a,error:b}=await supabase.rpc("transfer_tokens_secure",{dealer_id_in:e,amount_in:f});b?(D.textContent="Failed to transfer tokens: "+b.message,D.style.color="red",console.error("Database function call failed:",b)):(D.textContent="Tokens transferred successfully!",D.style.color="green",y.reset(),await k())}),f&&f.addEventListener("click",async()=>{g.textContent="Archiving...";const{error:a}=await supabase.rpc("archive_daily_results");a?(g.textContent="Archiving failed: "+a.message,g.style.color="red"):(g.textContent="Previous day's results archived successfully!",g.style.color="green",fetchTodayResults(),fetchOldResults())}),b.addEventListener("click",()=>{const c=d.value,a=e.value;c&&a?n(c,a):alert("Please select a dealer and a date.")}),c.addEventListener("click",()=>{const b=e.value;b?o(b):alert("Please select a date.")}),u.addEventListener("click",async()=>{const{error:a}=await supabase.auth.signOut();window.location.reload()})}async function setupDealerDashboard(){const{data:{session:e},error:b}=await supabase.auth.getSession();if(!e)return void(window.location.href="admin.html");const h=document.getElementById("dealer-name-display"),f=document.getElementById("current-token-balance"),g=document.getElementById("logout-btn"),m=document.getElementById("betting-form"),k=document.getElementById("bet-number"),o=document.getElementById("bet-amount"),p=document.getElementById("bet-message"),q=document.getElementById("slips-container"),l=document.getElementById("baji-select"),i=document.getElementById("betting-closed-message"),{data:c,error:d}=await supabase.from("dealers").select("id, name").eq("user_id",e.user.id).single();if(c){async function d(){const{data:a,error:b}=await supabase.from("dealers").select("token_balance").eq("id",j).single();a?f.textContent=`Your Token Balance: ${a.token_balance||0} tokens`:console.error("Failed to fetch dealer balance:",b.message)}async function b(){const c=[{id:1,time:"11:00 AM",hour:11,minute:0},{id:2,time:"12:30 PM",hour:12,minute:30},{id:3,time:"2:00 PM",hour:14,minute:0},{id:4,time:"3:30 PM",hour:15,minute:30},{id:5,time:"5:00 PM",hour:17,minute:0},{id:6,time:"6:30 PM",hour:18,minute:30},{id:7,time:"8:00 PM",hour:20,minute:0},{id:8,time:"9:00 PM",hour:21,minute:0}];l.innerHTML="";const e=new Date,d=[];if(c.forEach(b=>{const a=new Date(e.getFullYear(),e.getMonth(),e.getDate(),b.hour,b.minute);a>e&&d.push({...b,date:e})}),0===d.length){const a=new Date(e);a.setDate(e.getDate()+1),d.push({...c[0],date:a})}const b=d.find(b=>{const d=new Date(b.date.getFullYear(),b.date.getMonth(),b.date.getDate(),b.hour,b.minute),a=(d.getTime()-e.getTime())/6e4;return 20<a});if(b){const f=document.createElement("option");f.value=b.id;const a=b.date.getDate()!==e.getDate(),c=a?" (Tomorrow)":"";f.textContent=`${b.id}th Baji - ${b.time}${c}`,l.appendChild(f),m.style.display="block",i.style.display="none"}else m.style.display="none",i.style.display="block"}async function e(a){const b=new Date().toISOString().split("T")[0],{data:c,error:d}=await supabase.from("plays").select("*").eq("dealer_id",a).eq("play_date",b).order("baji_slot",{ascending:!0});if(d||!c||0===c.length)return void(q.innerHTML="<p style=\"text-align: center;\">No bets placed today.</p>");const{data:l}=await supabase.from("results").select("*").eq("date",b);q.innerHTML="",c.forEach(b=>{const c=document.createElement("div");c.className="admin-section";const d=l.find(c=>c.slot_id===b.baji_slot),f=d?d.single_number:"-",g=Object.keys(b.played_numbers)[0],h=b.played_numbers[g],i="-"!==f&&parseInt(g)===f,k=i?90*h:0,j=i?"green":"red",e=i?"Congratulations, you won!":"Sorry, you lost.";c.innerHTML=`
                    <h3>${b.baji_slot}th Baji - ${b.play_time}</h3>
                    <p><strong>Your Number:</strong> ${g} (Tokens: ${h})</p>
                    <p><strong>Winning Number:</strong> ${f}</p>
                    <p style="color: ${j}; font-weight: bold;">${e}</p>
                    <p><strong>Prize Tokens:</strong> ${k}</p>
                `,q.appendChild(c)})}h.textContent=`Welcome, ${c.name}!`;const j=c.id;g.addEventListener("click",async()=>{const{error:a}=await supabase.auth.signOut();window.location.href="admin.html"}),m.addEventListener("submit",async f=>{f.preventDefault();const g=parseInt(l.value),h=parseInt(k.value),a=parseInt(o.value);if(isNaN(h)||0>h||9<h||isNaN(a)||0>=a)return p.textContent="Please enter a valid number (0-9) and amount.",void(p.style.color="red");const{error:b}=await supabase.rpc("place_bet",{dealer_id_in:j,baji_slot_in:g,bet_number_in:h.toString(),bet_amount_in:a});return b?(p.textContent="Failed to place bet: "+b.message,void(p.style.color="red")):void(p.textContent="Bet placed successfully!",p.style.color="green",m.reset(),await d(),await e(j))}),d(),b(),e(j),setInterval(()=>{d(),e(j),b()},5e3)}else h.textContent=`Error! Dealer not found.`,console.error("Failed to fetch dealer name:",d.message)}function setupLoginButton(){const a=document.getElementById("login-link");a&&(a.href="admin.html")}async function fetchTodayResults(){const c=new Date().toISOString().split("T")[0],{data:e,error:a}=await supabase.from("results").select("*").eq("date",c).order("slot_id",{ascending:!0});if(a)return void console.error("Error fetching today's results:",a.message);const h=document.querySelector(".today-result .results-grid");h.innerHTML="";const i=new Map;e.forEach(a=>{i.set(a.slot_id,a)});for(let c=1;8>=c;c++){const d=i.get(c),e=d?d.patti_number:"- - -",f=d?d.single_number:"-",a=document.createElement("div");a.className="result-box-item",a.innerHTML=`
            <div class="patti">${e}</div>
            <div class="single">${f}</div>
        `,h.appendChild(a)}document.getElementById("current-date").textContent=new Date().toLocaleDateString("en-US")}async function fetchOldResults(){const{data:c,error:a}=await supabase.from("old_results").select("*").order("date",{ascending:!1}).limit(100);if(a)return void console.error("Error fetching old results:",a.message);const f=c.reduce((c,d)=>{const a=d.date;return c[a]||(c[a]=[]),c[a].push(d),c},{}),d=document.querySelector(".old-results-container");for(const c in d.innerHTML="",f){const a=document.createElement("div");a.className="old-results-day",a.innerHTML=`
            <div class="result-date">${new Date(c).toLocaleDateString("en-US")}</div>
            <div class="results-grid"></div>
        `,d.appendChild(a);const h=a.querySelector(".results-grid"),g=f[c].sort((b,c)=>b.slot_id-c.slot_id);for(let c=1;8>=c;c++){const a=g.find(a=>a.slot_id===c),b=a?a.patti_number:"- - -",f=a?a.single_number:"-",d=document.createElement("div");d.className="result-box-item",d.innerHTML=`
                <div class="patti">${b}</div>
                <div class="single">${f}</div>
            `,h.appendChild(d)}}}function startLiveAnimation(){const a=document.querySelector(".today-result .date-header");a.classList.add("live-animation")}