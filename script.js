const SUPABASE_URL="https://urjcuxavrkyqttwtqvjx.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ",supabase=window.supabase.createClient("https://urjcuxavrkyqttwtqvjx.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ");document.addEventListener("DOMContentLoaded",()=>{window.location.pathname.endsWith("admin.html")?setupAdminPanel():window.location.pathname.endsWith("dealer-dashboard.html")?setupDealerDashboard():setupPublicWebsite()});function setupPublicWebsite(){fetchTodayResults(),fetchOldResults(),setupLoginButton(),startLiveAnimation(),supabase.channel("results_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"results"},b=>{console.log("New result added:",b.new),fetchTodayResults()}).subscribe()}async function setupAdminPanel(){async function i(){const{data:b,error:c}=await supabase.from("dealers").select("*");return c?void console.error("Failed to load dealers:",c.message):void(C.innerHTML="<option value=\"\">Select Dealer</option>",b.forEach(b=>{const c=document.createElement("option");c.value=b.id,c.textContent=`${b.name} (${b.token_balance||0} tokens)`,C.appendChild(c)}))}async function j(){const{data:b,error:c}=await supabase.from("dealers").select("id, name");return c?void console.error("Failed to load dealers for report:",c.message):void(D.innerHTML="<option value=\"\">Select Dealer</option>",b.forEach(b=>{const c=document.createElement("option");c.value=b.id,c.textContent=b.name,D.appendChild(c)}))}async function k(e,a){const{data:b,error:c}=await supabase.from("plays").select("*").eq("dealer_id",e).eq("play_date",a);if(c||!b||0===b.length)return void(E.innerHTML="<p>No report found for this date.</p>");const{data:d}=await supabase.from("results").select("*").eq("date",a);E.innerHTML=`<h2>Report for ${a}</h2>`,E.innerHTML+="<table border=\"1\" style=\"width:100%; text-align:center;\">",E.innerHTML+="<thead><tr><th>Time</th><th>Played Numbers</th><th>Winning Number</th><th>Spent</th><th>Prize</th><th>Profit/Loss</th></tr></thead>",E.innerHTML+="<tbody>";let g=0,k=0;b.forEach(i=>{const f=d.find(b=>b.slot_id===i.baji_slot),e=f?f.single_number:"-",h=Object.keys(i.played_numbers).map(b=>`${b}(${i.played_numbers[b]})`).join(", "),a="-"!==e&&i.played_numbers[e]?90*i.played_numbers[e]:0,b=a-i.total_spent_tokens;g+=i.total_spent_tokens,k+=a,E.innerHTML+=`
                <tr>
                    <td>${i.play_time}</td>
                    <td>${h}</td>
                    <td>${e}</td>
                    <td>${i.total_spent_tokens}</td>
                    <td>${a}</td>
                    <td>${b}</td>
                </tr>
            `}),E.innerHTML+=`
            <tr>
                <td colspan="3">Total</td>
                <td>${g}</td>
                <td>${k}</td>
                <td>${k-g}</td>
            </tr>
        `,E.innerHTML+="</tbody></table>",F.innerHTML=""}async function l(d){const{data:e,error:f}=await supabase.from("plays").select("played_numbers").eq("play_date",d);if(f||!e||0===e.length)return F.innerHTML="<p>No data found for this date.</p>",void(G&&G.destroy());const g={};e.forEach(b=>{for(const c in b.played_numbers){const d=b.played_numbers[c];g[c]?g[c]+=d:g[c]=d}});const h=Object.keys(g).sort((a,b)=>a-b),a=h.map(b=>g[b]);G&&G.destroy();const b=document.getElementById("myChart").getContext("2d");G=new Chart(b,{type:"bar",data:{labels:h,datasets:[{label:"Most tokens placed on",data:a,backgroundColor:"rgba(243, 156, 18, 0.7)",borderColor:"rgba(243, 156, 18, 1)",borderWidth:1}]},options:{responsive:!0,scales:{x:{title:{display:!0,text:"Number"}},y:{beginAtZero:!0,title:{display:!0,text:"Tokens"}}}}}),E.innerHTML=""}const{data:{session:n},error:m}=await supabase.auth.getSession(),o=document.getElementById("common-login-form"),p=document.getElementById("login-section"),q=document.getElementById("data-entry-section"),r=document.getElementById("logout-btn"),s=document.getElementById("auth-error"),t=document.getElementById("result-form"),u=document.getElementById("dealer-form"),v=document.getElementById("token-transfer-form"),w=document.getElementById("baji-select"),x=document.querySelectorAll(".tab-button"),y=document.querySelectorAll(".tab-content"),z=document.getElementById("result-message"),A=document.getElementById("dealer-message"),B=document.getElementById("token-message"),C=document.getElementById("dealer-select"),D=document.getElementById("report-dealer-select"),d=document.getElementById("report-date-input"),a=document.getElementById("showReportBtn"),b=document.getElementById("showGraphBtn"),E=document.getElementById("reportContainer"),F=document.getElementById("graphContainer"),c=document.getElementById("archive-btn"),e=document.getElementById("archive-message");let G=null;(function b(){w.innerHTML="";for(let b=1;8>=b;b++){const c=document.createElement("option");c.value=b,c.textContent=`Baji ${b}`,w.appendChild(c)}})(),n?(p.style.display="none",q.style.display="block",r.style.display="block",await i(),await j()):(p.style.display="block",q.style.display="none",r.style.display="none"),x.forEach(b=>{b.addEventListener("click",()=>{x.forEach(b=>b.classList.remove("active")),y.forEach(b=>b.classList.remove("active")),b.classList.add("active");const c=b.dataset.tab;document.getElementById(c).classList.add("active"),G&&(G.destroy(),G=null)})}),o.addEventListener("submit",async b=>{b.preventDefault();const c=document.getElementById("email-input").value,d=document.getElementById("password-input").value;s.textContent="";const{data:e,error:f}=await supabase.auth.signInWithPassword({email:c,password:d});if(f)return void(s.textContent="Login failed: "+f.message);const{data:{user:h}}=await supabase.auth.getUser();if(h){const{data:b,error:c}=await supabase.from("dealers").select("id").eq("user_id",h.id).single();window.location.href=b?`dealer-dashboard.html?dealerId=${b.id}`:"admin.html"}}),t.addEventListener("submit",async f=>{f.preventDefault();const g=document.getElementById("date-input").value,h=parseInt(w.value),a=document.getElementById("patti-input").value,b=parseInt(document.getElementById("single-input").value),c=new Date().toISOString().split("T")[0];let d=null;d=g===c?"results":"old_results";const{error:j}=await supabase.from(d).upsert({date:g,slot_id:h,patti_number:a,single_number:b});j?(z.textContent="Failed to save result: "+j.message,z.style.color="red"):(z.textContent="Result saved successfully!",z.style.color="green",t.reset(),g===c?fetchTodayResults():fetchOldResults())}),u.addEventListener("submit",async b=>{b.preventDefault();const g=document.getElementById("dealer-name").value,d=document.getElementById("dealer-phone").value,e=document.getElementById("dealer-password").value,f=document.getElementById("dealer-message");f.textContent="Adding dealer...",f.className="message";try{const{error:b}=await supabase.rpc("create_dealer",{dealer_name:g,dealer_phone:d,dealer_password:e});if(b)throw b;f.textContent="Dealer added successfully!",f.className="message success-message",document.getElementById("dealer-form").reset(),await i(),await j()}catch(b){f.textContent=`Failed to add dealer: ${b.message}`,f.className="message error-message",console.error("Error adding dealer:",b)}}),v.addEventListener("submit",async c=>{c.preventDefault();const d=document.getElementById("dealer-select").value,e=parseInt(document.getElementById("token-amount").value);if(!d||isNaN(e)||0>=e)return B.textContent="Please enter a valid amount and select a dealer.",void(B.style.color="red");const{data:f,error:a}=await supabase.rpc("transfer_tokens_secure",{dealer_id_in:d,amount_in:e});a?(B.textContent="Failed to transfer tokens: "+a.message,B.style.color="red",console.error("Database function call failed:",a)):(B.textContent="Tokens transferred successfully!",B.style.color="green",v.reset(),await i())}),c&&c.addEventListener("click",async()=>{e.textContent="Archiving...";const{error:b}=await supabase.rpc("archive_daily_results");b?(e.textContent="Archiving failed: "+b.message,e.style.color="red"):(e.textContent="Previous day's results archived successfully!",e.style.color="green",fetchTodayResults(),fetchOldResults())}),a.addEventListener("click",()=>{const b=D.value,c=d.value;b&&c?k(b,c):alert("Please select a dealer and a date.")}),b.addEventListener("click",()=>{const a=d.value;a?l(a):alert("Please select a date.")}),r.addEventListener("click",async()=>{const{error:b}=await supabase.auth.signOut();window.location.reload()})}async function setupDealerDashboard(){const{data:{session:b},error:a}=await supabase.auth.getSession();if(!b)return void(window.location.href="admin.html");const n=document.getElementById("dealer-name-display"),e=document.getElementById("current-token-balance"),f=document.getElementById("logout-btn"),r=document.getElementById("betting-form"),m=document.getElementById("bet-number"),k=document.getElementById("bet-amount"),o=document.getElementById("bet-message"),p=document.getElementById("slips-container"),q=document.getElementById("baji-select"),g=document.getElementById("betting-closed-message"),{data:h,error:c}=await supabase.from("dealers").select("id, name").eq("user_id",b.user.id).single();if(h){async function c(){const{data:c,error:a}=await supabase.from("dealers").select("token_balance").eq("id",i).single();c?e.textContent=`Your Token Balance: ${c.token_balance||0} tokens`:console.error("Failed to fetch dealer balance:",a.message)}async function a(){const f=[{id:1,time:"11:00 AM",hour:11,minute:0},{id:2,time:"12:30 PM",hour:12,minute:30},{id:3,time:"2:00 PM",hour:14,minute:0},{id:4,time:"3:30 PM",hour:15,minute:30},{id:5,time:"5:00 PM",hour:17,minute:0},{id:6,time:"6:30 PM",hour:18,minute:30},{id:7,time:"8:00 PM",hour:20,minute:0},{id:8,time:"9:00 PM",hour:21,minute:0}];q.innerHTML="";const h=new Date,c=[];if(f.forEach(d=>{const b=new Date(h.getFullYear(),h.getMonth(),h.getDate(),d.hour,d.minute);b>h&&c.push({...d,date:h})}),0===c.length){const b=new Date(h);b.setDate(h.getDate()+1),c.push({...f[0],date:b})}const d=c.find(c=>{const b=new Date(c.date.getFullYear(),c.date.getMonth(),c.date.getDate(),c.hour,c.minute),d=(b.getTime()-h.getTime())/6e4;return 20<d});if(d){const b=document.createElement("option");b.value=d.id;const e=d.date.getDate()!==h.getDate(),a=e?" (Tomorrow)":"";b.textContent=`${d.id}th Baji - ${d.time}${a}`,q.appendChild(b),r.style.display="block",g.style.display="none"}else r.style.display="none",g.style.display="block"}async function d(e){const a=new Date().toISOString().split("T")[0],{data:b,error:c}=await supabase.from("plays").select("*").eq("dealer_id",e).eq("play_date",a).order("baji_slot",{ascending:!0});if(c||!b||0===b.length)return void(p.innerHTML="<p style=\"text-align: center;\">No bets placed today.</p>");const{data:m}=await supabase.from("results").select("*").eq("date",a);p.innerHTML="",b.forEach(a=>{const b=document.createElement("div");b.className="admin-section";const c=m.find(b=>b.slot_id===a.baji_slot),d=c?c.single_number:"-",f=Object.keys(a.played_numbers)[0],g=a.played_numbers[f],h="-"!==d&&parseInt(f)===d,i=h?90*g:0,k=h?"green":"red",j=h?"Congratulations, you won!":"Sorry, you lost.";b.innerHTML=`
                    <h3>${a.baji_slot}th Baji - ${a.play_time}</h3>
                    <p><strong>Your Number:</strong> ${f} (Tokens: ${g})</p>
                    <p><strong>Winning Number:</strong> ${d}</p>
                    <p style="color: ${k}; font-weight: bold;">${j}</p>
                    <p><strong>Prize Tokens:</strong> ${i}</p>
                `,p.appendChild(b)})}n.textContent=`Welcome, ${h.name}!`;const i=h.id;f.addEventListener("click",async()=>{const{error:b}=await supabase.auth.signOut();window.location.href="admin.html"}),r.addEventListener("submit",async e=>{e.preventDefault();const f=parseInt(q.value),g=parseInt(m.value),h=parseInt(k.value);if(isNaN(g)||0>g||9<g||isNaN(h)||0>=h)return o.textContent="Please enter a valid number (0-9) and amount.",void(o.style.color="red");const{error:a}=await supabase.rpc("place_bet",{dealer_id_in:i,baji_slot_in:f,bet_number_in:g.toString(),bet_amount_in:h});return a?(o.textContent="Failed to place bet: "+a.message,void(o.style.color="red")):void(o.textContent="Bet placed successfully!",o.style.color="green",r.reset(),await c(),await d(i))}),c(),a(),d(i),setInterval(()=>{c(),d(i),a()},5e3)}else n.textContent=`Error! Dealer not found.`,console.error("Failed to fetch dealer name:",c.message)}function setupLoginButton(){const b=document.getElementById("login-link");b&&(b.href="admin.html")}async function fetchTodayResults(){const b=new Date().toISOString().split("T")[0],{data:c,error:d}=await supabase.from("results").select("*").eq("date",b).order("slot_id",{ascending:!0});if(d)return void console.error("Error fetching today's results:",d.message);const g=document.querySelector(".today-result .results-grid");g.innerHTML="";const h=new Map;c.forEach(b=>{h.set(b.slot_id,b)});for(let b=1;8>=b;b++){const c=h.get(b),d=c?c.patti_number:"- - -",e=c?c.single_number:"-",f=document.createElement("div");f.className="result-box-item",f.innerHTML=`
            <div class="patti">${d}</div>
            <div class="single">${e}</div>
        `,g.appendChild(f)}document.getElementById("current-date").textContent=new Date().toLocaleDateString("en-US")}async function fetchOldResults(){const{data:b,error:c}=await supabase.from("old_results").select("*").order("date",{ascending:!1}).limit(100);if(c)return void console.error("Error fetching old results:",c.message);const e=b.reduce((b,c)=>{const d=c.date;return b[d]||(b[d]=[]),b[d].push(c),b},{}),f=document.querySelector(".old-results-container");for(const b in f.innerHTML="",e){const c=document.createElement("div");c.className="old-results-day",c.innerHTML=`
            <div class="result-date">${new Date(b).toLocaleDateString("en-US")}</div>
            <div class="results-grid"></div>
        `,f.appendChild(c);const i=c.querySelector(".results-grid"),h=e[b].sort((a,b)=>a.slot_id-b.slot_id);for(let b=1;8>=b;b++){const c=h.find(c=>c.slot_id===b),a=c?c.patti_number:"- - -",e=c?c.single_number:"-",f=document.createElement("div");f.className="result-box-item",f.innerHTML=`
                <div class="patti">${a}</div>
                <div class="single">${e}</div>
            `,i.appendChild(f)}}}function startLiveAnimation(){const b=document.querySelector(".today-result .date-header");b.classList.add("live-animation")}