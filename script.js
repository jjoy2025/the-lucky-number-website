const SUPABASE_URL="https://urjcuxavrkyqttwtqvjx.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ",supabase=window.supabase.createClient("https://urjcuxavrkyqttwtqvjx.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ");document.addEventListener("DOMContentLoaded",()=>{window.location.pathname.endsWith("admin.html")?setupAdminPanel():window.location.pathname.endsWith("dealer-dashboard.html")?setupDealerDashboard():setupPublicWebsite()});function setupPublicWebsite(){fetchTodayResults(),fetchOldResults(),setupLoginButton(),startLiveAnimation(),supabase.channel("results_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"results"},b=>{console.log("New result added:",b.new),fetchTodayResults()}).subscribe()}async function setupAdminPanel(){async function F(){const{data:c,error:a}=await supabase.from("dealers").select("*");return a?void console.error("Failed to load dealers:",a.message):void(x.innerHTML="<option value=\"\">Select Dealer</option>",c.forEach(c=>{const a=document.createElement("option");a.value=c.id,a.textContent=`${c.name} (${c.token_balance||0} tokens)`,x.appendChild(a)}))}async function h(){const{data:c,error:a}=await supabase.from("dealers").select("id, name");return a?void console.error("Failed to load dealers for report:",a.message):void(y.innerHTML="<option value=\"\">Select Dealer</option>",c.forEach(c=>{const a=document.createElement("option");a.value=c.id,a.textContent=c.name,y.appendChild(a)}))}async function e(g,f){const{data:e,error:a}=await supabase.from("plays").select("*").eq("dealer_id",g).eq("play_date",f);if(a||!e||0===e.length)return void(B.innerHTML="<p>No report found for this date.</p>");const{data:b}=await supabase.from("results").select("*").eq("date",f);B.innerHTML=`<h2>Report for ${f}</h2>`,B.innerHTML+="<table border=\"1\" style=\"width:100%; text-align:center;\">",B.innerHTML+="<thead><tr><th>Time</th><th>Played Numbers</th><th>Winning Number</th><th>Spent</th><th>Prize</th><th>Profit/Loss</th></tr></thead>",B.innerHTML+="<tbody>";let c=0,k=0;e.forEach(d=>{const g=b.find(b=>b.slot_id===d.baji_slot),i=g?g.single_number:"-",f=Object.keys(d.played_numbers).map(b=>`${b}(${d.played_numbers[b]})`).join(", "),e="-"!==i&&d.played_numbers[i]?90*d.played_numbers[i]:0,h=e-d.total_spent_tokens;c+=d.total_spent_tokens,k+=e,B.innerHTML+=`
                <tr>
                    <td>${d.play_time}</td>
                    <td>${f}</td>
                    <td>${i}</td>
                    <td>${d.total_spent_tokens}</td>
                    <td>${e}</td>
                    <td>${h}</td>
                </tr>
            `}),B.innerHTML+=`
            <tr>
                <td colspan="3">Total</td>
                <td>${c}</td>
                <td>${k}</td>
                <td>${k-c}</td>
            </tr>
        `,B.innerHTML+="</tbody></table>",C.innerHTML=""}async function f(b){const{data:c,error:d}=await supabase.from("plays").select("played_numbers").eq("play_date",b);if(d||!c||0===c.length)return C.innerHTML="<p>No data found for this date.</p>",void(D&&D.destroy());const e={};c.forEach(d=>{for(const a in d.played_numbers){const b=d.played_numbers[a];e[a]?e[a]+=b:e[a]=b}});const f=Object.keys(e).sort((b,c)=>b-c),g=f.map(b=>e[b]);D&&D.destroy();const h=document.getElementById("myChart").getContext("2d");D=new Chart(h,{type:"bar",data:{labels:f,datasets:[{label:"Most tokens placed on",data:g,backgroundColor:"rgba(243, 156, 18, 0.7)",borderColor:"rgba(243, 156, 18, 1)",borderWidth:1}]},options:{responsive:!0,scales:{x:{title:{display:!0,text:"Number"}},y:{beginAtZero:!0,title:{display:!0,text:"Tokens"}}}}}),B.innerHTML=""}const{data:{session:i},error:g}=await supabase.auth.getSession(),j=document.getElementById("common-login-form"),k=document.getElementById("login-section"),l=document.getElementById("data-entry-section"),m=document.getElementById("logout-btn"),n=document.getElementById("auth-error"),o=document.getElementById("result-form"),p=document.getElementById("dealer-form"),q=document.getElementById("token-transfer-form"),r=document.getElementById("baji-select"),s=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-content"),u=document.getElementById("result-message"),v=document.getElementById("dealer-message"),w=document.getElementById("token-message"),x=document.getElementById("dealer-select"),y=document.getElementById("report-dealer-select"),z=document.getElementById("report-date-input"),A=document.getElementById("showReportBtn"),d=document.getElementById("showGraphBtn"),B=document.getElementById("reportContainer"),C=document.getElementById("graphContainer"),a=document.getElementById("archive-btn"),b=document.getElementById("archive-message");let D=null;(function b(){r.innerHTML="";for(let c=1;8>=c;c++){const a=document.createElement("option");a.value=c,a.textContent=`Baji ${c}`,r.appendChild(a)}})(),i?(k.style.display="none",l.style.display="block",m.style.display="block",await F(),await h()):(k.style.display="block",l.style.display="none",m.style.display="none"),s.forEach(c=>{c.addEventListener("click",()=>{s.forEach(b=>b.classList.remove("active")),t.forEach(b=>b.classList.remove("active")),c.classList.add("active");const a=c.dataset.tab;document.getElementById(a).classList.add("active"),D&&(D.destroy(),D=null)})}),j.addEventListener("submit",async g=>{g.preventDefault();const a=document.getElementById("email-input").value,b=document.getElementById("password-input").value;n.textContent="";const{data:c,error:d}=await supabase.auth.signInWithPassword({email:a,password:b});if(d)return void(n.textContent="Login failed: "+d.message);const{data:{user:e}}=await supabase.auth.getUser();if(e){const{data:c,error:a}=await supabase.from("dealers").select("id").eq("user_id",e.id).single();window.location.href=c?`dealer-dashboard.html?dealerId=${c.id}`:"admin.html"}}),o.addEventListener("submit",async d=>{d.preventDefault();const e=document.getElementById("date-input").value,f=parseInt(r.value),g=document.getElementById("patti-input").value,h=parseInt(document.getElementById("single-input").value),a=new Date().toISOString().split("T")[0];let b=null;b=e===a?"results":"old_results";const{error:j}=await supabase.from(b).upsert({date:e,slot_id:f,patti_number:g,single_number:h});j?(u.textContent="Failed to save result: "+j.message,u.style.color="red"):(u.textContent="Result saved successfully!",u.style.color="green",o.reset(),e===a?fetchTodayResults():fetchOldResults())}),p.addEventListener("submit",async b=>{b.preventDefault();const f=document.getElementById("dealer-name").value,c=document.getElementById("dealer-phone").value,g=document.getElementById("dealer-password").value,d=document.getElementById("dealer-message");d.textContent="Adding dealer...",d.className="message";try{const{error:b}=await supabase.rpc("create_dealer",{dealer_name:f,dealer_phone:c,dealer_password:g});if(b)throw b;d.textContent="Dealer added successfully!",d.className="message success-message",document.getElementById("dealer-form").reset(),await F(),await h()}catch(b){d.textContent=`Failed to add dealer: ${b.message}`,d.className="message error-message",console.error("Error adding dealer:",b)}}),q.addEventListener("submit",async a=>{a.preventDefault();const b=document.getElementById("dealer-select").value,c=parseInt(document.getElementById("token-amount").value);if(!b||isNaN(c)||0>=c)return w.textContent="Please enter a valid amount and select a dealer.",void(w.style.color="red");const{data:d,error:e}=await supabase.rpc("transfer_tokens_secure",{dealer_id_in:b,amount_in:c});e?(w.textContent="Failed to transfer tokens: "+e.message,w.style.color="red",console.error("Database function call failed:",e)):(w.textContent="Tokens transferred successfully!",w.style.color="green",q.reset(),await F())}),a&&a.addEventListener("click",async()=>{b.textContent="Archiving...";const{error:c}=await supabase.rpc("archive_daily_results");c?(b.textContent="Archiving failed: "+c.message,b.style.color="red"):(b.textContent="Previous day's results archived successfully!",b.style.color="green",fetchTodayResults(),fetchOldResults())}),A.addEventListener("click",()=>{const c=y.value,a=z.value;c&&a?e(c,a):alert("Please select a dealer and a date.")}),d.addEventListener("click",()=>{const a=z.value;a?f(a):alert("Please select a date.")}),m.addEventListener("click",async()=>{const{error:b}=await supabase.auth.signOut();window.location.reload()})}async function setupDealerDashboard(){const{data:{session:d},error:c}=await supabase.auth.getSession();if(!d)return void(window.location.href="admin.html");const a=document.getElementById("dealer-name-display"),h=document.getElementById("current-token-balance"),b=document.getElementById("logout-btn"),j=document.getElementById("betting-form"),l=document.getElementById("bet-number"),n=document.getElementById("bet-amount"),m=document.getElementById("bet-message"),q=document.getElementById("slips-container"),k=document.getElementById("baji-select"),o=document.getElementById("betting-closed-message"),{data:e,error:f}=await supabase.from("dealers").select("id, name").eq("user_id",d.user.id).single();if(e){async function i(){const{data:a,error:b}=await supabase.from("dealers").select("token_balance").eq("id",r).single();a?h.textContent=`Your Token Balance: ${a.token_balance||0} tokens`:console.error("Failed to fetch dealer balance:",b.message)}async function f(){const b=[{id:1,time:"11:00 AM",hour:11,minute:0},{id:2,time:"12:30 PM",hour:12,minute:30},{id:3,time:"2:00 PM",hour:14,minute:0},{id:4,time:"3:30 PM",hour:15,minute:30},{id:5,time:"5:00 PM",hour:17,minute:0},{id:6,time:"6:30 PM",hour:18,minute:30},{id:7,time:"8:00 PM",hour:20,minute:0},{id:8,time:"9:00 PM",hour:21,minute:0}];k.innerHTML="";const g=new Date,d=[];if(b.forEach(b=>{const a=new Date(g.getFullYear(),g.getMonth(),g.getDate(),b.hour,b.minute);a>g&&d.push({...b,date:g})}),0===d.length){const a=new Date(g);a.setDate(g.getDate()+1),d.push({...b[0],date:a})}const a=d.find(d=>{const a=new Date(d.date.getFullYear(),d.date.getMonth(),d.date.getDate(),d.hour,d.minute),c=(a.getTime()-g.getTime())/6e4;return 20<c});if(a){const c=document.createElement("option");c.value=a.id;const d=a.date.getDate()!==g.getDate(),b=d?" (Tomorrow)":"";c.textContent=`${a.id}th Baji - ${a.time}${b}`,k.appendChild(c),j.style.display="block",o.style.display="none"}else j.style.display="none",o.style.display="block"}async function p(c){const d=new Date().toISOString().split("T")[0],{data:e,error:a}=await supabase.from("plays").select("*").eq("dealer_id",c).eq("play_date",d).order("baji_slot",{ascending:!0});if(a||!e||0===e.length)return void(q.innerHTML="<p style=\"text-align: center;\">No bets placed today.</p>");const{data:j}=await supabase.from("results").select("*").eq("date",d);q.innerHTML="",e.forEach(l=>{const e=document.createElement("div");e.className="admin-section";const a=j.find(b=>b.slot_id===l.baji_slot),b=a?a.single_number:"-",c=Object.keys(l.played_numbers)[0],d=l.played_numbers[c],f="-"!==b&&parseInt(c)===b,g=f?90*d:0,h=f?"green":"red",i=f?"Congratulations, you won!":"Sorry, you lost.";e.innerHTML=`
                    <h3>${l.baji_slot}th Baji - ${l.play_time}</h3>
                    <p><strong>Your Number:</strong> ${c} (Tokens: ${d})</p>
                    <p><strong>Winning Number:</strong> ${b}</p>
                    <p style="color: ${h}; font-weight: bold;">${i}</p>
                    <p><strong>Prize Tokens:</strong> ${g}</p>
                `,q.appendChild(e)})}a.textContent=`Welcome, ${e.name}!`;const r=e.id;b.addEventListener("click",async()=>{const{error:b}=await supabase.auth.signOut();window.location.href="admin.html"}),j.addEventListener("submit",async a=>{a.preventDefault();const b=parseInt(k.value),c=parseInt(l.value),d=parseInt(n.value);if(isNaN(c)||0>c||9<c||isNaN(d)||0>=d)return m.textContent="Please enter a valid number (0-9) and amount.",void(m.style.color="red");const{error:e}=await supabase.rpc("place_bet",{dealer_id_in:r,baji_slot_in:b,bet_number_in:c.toString(),bet_amount_in:d});return e?(m.textContent="Failed to place bet: "+e.message,void(m.style.color="red")):void(m.textContent="Bet placed successfully!",m.style.color="green",j.reset(),await i(),await p(r))}),i(),f(),p(r),setInterval(()=>{i(),p(r),f()},5e3)}else a.textContent=`Error! Dealer not found.`,console.error("Failed to fetch dealer name:",f.message)}function setupLoginButton(){const b=document.getElementById("login-link");b&&(b.href="admin.html")}async function fetchTodayResults(){const d=new Date().toISOString().split("T")[0],{data:a,error:b}=await supabase.from("results").select("*").eq("date",d).order("slot_id",{ascending:!0});if(b)return void console.error("Error fetching today's results:",b.message);const f=document.querySelector(".today-result .results-grid");f.innerHTML="";const h=new Map;a.forEach(b=>{h.set(b.slot_id,b)});for(let g=1;8>=g;g++){const a=h.get(g),b=a?a.patti_number:"- - -",c=a?a.single_number:"-",d=document.createElement("div");d.className="result-box-item",d.innerHTML=`
            <div class="patti">${b}</div>
            <div class="single">${c}</div>
        `,f.appendChild(d)}document.getElementById("current-date").textContent=new Date().toLocaleDateString("en-US")}async function fetchOldResults(){const{data:c,error:a}=await supabase.from("old_results").select("*").order("date",{ascending:!1}).limit(100);if(a)return void console.error("Error fetching old results:",a.message);const f=c.reduce((d,a)=>{const b=a.date;return d[b]||(d[b]=[]),d[b].push(a),d},{}),d=document.querySelector(".old-results-container");for(const c in d.innerHTML="",f){const a=document.createElement("div");a.className="old-results-day",a.innerHTML=`
            <div class="result-date">${new Date(c).toLocaleDateString("en-US")}</div>
            <div class="results-grid"></div>
        `,d.appendChild(a);const h=a.querySelector(".results-grid"),g=f[c].sort((b,c)=>b.slot_id-c.slot_id);for(let c=1;8>=c;c++){const a=g.find(a=>a.slot_id===c),b=a?a.patti_number:"- - -",f=a?a.single_number:"-",d=document.createElement("div");d.className="result-box-item",d.innerHTML=`
                <div class="patti">${b}</div>
                <div class="single">${f}</div>
            `,h.appendChild(d)}}}function startLiveAnimation(){const b=document.querySelector(".today-result .date-header");b.classList.add("live-animation")}