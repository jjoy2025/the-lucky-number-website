const SUPABASE_URL="https://urjcuxavrkyqttwtqvjx.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ",supabase=window.supabase.createClient("https://urjcuxavrkyqttwtqvjx.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ");document.addEventListener("DOMContentLoaded",()=>{window.location.pathname.endsWith("admin.html")?setupAdminPanel():window.location.pathname.endsWith("dealer-dashboard.html")?setupDealerDashboard():setupPublicWebsite()});function setupPublicWebsite(){fetchTodayResults(),fetchOldResults(),setupLoginButton(),startLiveAnimation(),supabase.channel("results_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"results"},b=>{console.log("New result added:",b.new),fetchTodayResults()}).subscribe()}async function setupAdminPanel(){async function p(){const{data:a,error:b}=await supabase.from("dealers").select("*");return b?void console.error("Failed to load dealers:",b.message):void(d.innerHTML="<option value=\"\">Select Dealer</option>",a.forEach(a=>{const b=document.createElement("option");b.value=a.id,b.textContent=`${a.name} (${a.token_balance||0} tokens)`,d.appendChild(b)}))}async function q(){const{data:a,error:b}=await supabase.from("dealers").select("id, name");return b?void console.error("Failed to load dealers for report:",b.message):void(e.innerHTML="<option value=\"\">Select Dealer</option>",a.forEach(a=>{const b=document.createElement("option");b.value=a.id,b.textContent=a.name,e.appendChild(b)}))}async function r(b,c){const{data:d,error:e}=await supabase.from("plays").select("*").eq("dealer_id",b).eq("play_date",c);if(e||!d||0===d.length)return void(H.innerHTML="<p>No report found for this date.</p>");const{data:k}=await supabase.from("results").select("*").eq("date",c);H.innerHTML=`<h2>Report for ${c}</h2>`,H.innerHTML+="<table border=\"1\" style=\"width:100%; text-align:center;\">",H.innerHTML+="<thead><tr><th>Time</th><th>Played Numbers</th><th>Winning Number</th><th>Spent</th><th>Prize</th><th>Profit/Loss</th></tr></thead>",H.innerHTML+="<tbody>";let f=0,m=0;d.forEach(e=>{const h=k.find(b=>b.slot_id===e.baji_slot),a=h?h.single_number:"-",b=Object.keys(e.played_numbers).map(b=>`${b}(${e.played_numbers[b]})`).join(", "),c="-"!==a&&e.played_numbers[a]?90*e.played_numbers[a]:0,d=c-e.total_spent_tokens;f+=e.total_spent_tokens,m+=c,H.innerHTML+=`
                <tr>
                    <td>${e.play_time}</td>
                    <td>${b}</td>
                    <td>${a}</td>
                    <td>${e.total_spent_tokens}</td>
                    <td>${c}</td>
                    <td>${d}</td>
                </tr>
            `}),H.innerHTML+=`
            <tr>
                <td colspan="3">Total</td>
                <td>${f}</td>
                <td>${m}</td>
                <td>${m-f}</td>
            </tr>
        `,H.innerHTML+="</tbody></table>",l.innerHTML=""}async function s(f){const{data:g,error:a}=await supabase.from("plays").select("played_numbers").eq("play_date",f);if(a||!g||0===g.length)return l.innerHTML="<p>No data found for this date.</p>",void(j&&j.destroy());const i={};g.forEach(d=>{for(const a in d.played_numbers){const b=d.played_numbers[a];i[a]?i[a]+=b:i[a]=b}});const b=Object.keys(i).sort((c,a)=>c-a),c=b.map(b=>i[b]);j&&j.destroy();const d=document.getElementById("myChart").getContext("2d");j=new Chart(d,{type:"bar",data:{labels:b,datasets:[{label:"Most tokens placed on",data:c,backgroundColor:"rgba(243, 156, 18, 0.7)",borderColor:"rgba(243, 156, 18, 1)",borderWidth:1}]},options:{responsive:!0,scales:{x:{title:{display:!0,text:"Number"}},y:{beginAtZero:!0,title:{display:!0,text:"Tokens"}}}}}),H.innerHTML=""}const{data:{session:u},error:t}=await supabase.auth.getSession(),v=document.getElementById("common-login-form"),w=document.getElementById("login-section"),x=document.getElementById("data-entry-section"),y=document.getElementById("logout-btn"),z=document.getElementById("auth-error"),D=document.getElementById("result-form"),a=document.getElementById("dealer-form"),E=document.getElementById("token-transfer-form"),A=document.getElementById("baji-select"),B=document.querySelectorAll(".tab-button"),C=document.querySelectorAll(".tab-content"),F=document.getElementById("result-message"),b=document.getElementById("dealer-message"),G=document.getElementById("token-message"),d=document.getElementById("dealer-select"),e=document.getElementById("report-dealer-select"),f=document.getElementById("report-date-input"),c=document.getElementById("showReportBtn"),g=document.getElementById("showGraphBtn"),H=document.getElementById("reportContainer"),l=document.getElementById("graphContainer"),h=document.getElementById("archive-btn"),i=document.getElementById("archive-message");let j=null;(function b(){A.innerHTML="";for(let a=1;8>=a;a++){const b=document.createElement("option");b.value=a,b.textContent=`Baji ${a}`,A.appendChild(b)}})(),u?(w.style.display="none",x.style.display="block",y.style.display="block",await p(),await q()):(w.style.display="block",x.style.display="none",y.style.display="none"),B.forEach(a=>{a.addEventListener("click",()=>{B.forEach(b=>b.classList.remove("active")),C.forEach(b=>b.classList.remove("active")),a.classList.add("active");const b=a.dataset.tab;document.getElementById(b).classList.add("active"),j&&(j.destroy(),j=null)})}),v.addEventListener("submit",async e=>{e.preventDefault();const f=document.getElementById("email-input").value,g=document.getElementById("password-input").value;z.textContent="";const{data:a,error:b}=await supabase.auth.signInWithPassword({email:f,password:g});if(b)return void(z.textContent="Login failed: "+b.message);const{data:{user:h}}=await supabase.auth.getUser();if(h){const{data:a,error:b}=await supabase.from("dealers").select("id").eq("user_id",h.id).single();window.location.href=a?`dealer-dashboard.html?dealerId=${a.id}`:"admin.html"}}),D.addEventListener("submit",async h=>{h.preventDefault();const a=document.getElementById("date-input").value,b=parseInt(A.value),c=document.getElementById("patti-input").value,d=parseInt(document.getElementById("single-input").value),e=new Date().toISOString().split("T")[0];let f=null;f=a===e?"results":"old_results";const{error:j}=await supabase.from(f).upsert({date:a,slot_id:b,patti_number:c,single_number:d});j?(F.textContent="Failed to save result: "+j.message,F.style.color="red"):(F.textContent="Result saved successfully!",F.style.color="green",D.reset(),a===e?fetchTodayResults():fetchOldResults())}),a.addEventListener("submit",async b=>{b.preventDefault();const e=document.getElementById("dealer-name").value,f=document.getElementById("dealer-phone").value,c=document.getElementById("dealer-password").value,g=document.getElementById("dealer-message");g.textContent="Adding dealer...",g.className="message";try{const{error:b}=await supabase.rpc("create_dealer",{dealer_name:e,dealer_phone:f,dealer_password:c});if(b)throw b;g.textContent="Dealer added successfully!",g.className="message success-message",document.getElementById("dealer-form").reset(),await p(),await q()}catch(b){g.textContent=`Failed to add dealer: ${b.message}`,g.className="message error-message",console.error("Error adding dealer:",b)}}),E.addEventListener("submit",async e=>{e.preventDefault();const f=document.getElementById("dealer-select").value,a=parseInt(document.getElementById("token-amount").value);if(!f||isNaN(a)||0>=a)return G.textContent="Please enter a valid amount and select a dealer.",void(G.style.color="red");const{data:b,error:c}=await supabase.rpc("transfer_tokens_secure",{dealer_id_in:f,amount_in:a});c?(G.textContent="Failed to transfer tokens: "+c.message,G.style.color="red",console.error("Database function call failed:",c)):(G.textContent="Tokens transferred successfully!",G.style.color="green",E.reset(),await p())}),h&&h.addEventListener("click",async()=>{i.textContent="Archiving...";const{error:b}=await supabase.rpc("archive_daily_results");b?(i.textContent="Archiving failed: "+b.message,i.style.color="red"):(i.textContent="Previous day's results archived successfully!",i.style.color="green",fetchTodayResults(),fetchOldResults())}),c.addEventListener("click",()=>{const a=e.value,b=f.value;a&&b?r(a,b):alert("Please select a dealer and a date.")}),g.addEventListener("click",()=>{const a=f.value;a?s(a):alert("Please select a date.")}),y.addEventListener("click",async()=>{const{error:b}=await supabase.auth.signOut();window.location.reload()})}async function setupDealerDashboard(){const{data:{session:f},error:e}=await supabase.auth.getSession();if(!f)return void(window.location.href="admin.html");const m=document.getElementById("dealer-name-display"),g=document.getElementById("current-token-balance"),c=document.getElementById("logout-btn"),k=document.getElementById("betting-form"),o=document.getElementById("bet-number"),p=document.getElementById("bet-amount"),q=document.getElementById("bet-message"),l=document.getElementById("slips-container"),n=document.getElementById("baji-select"),j=document.getElementById("betting-closed-message"),{data:d,error:a}=await supabase.from("dealers").select("id, name").eq("user_id",f.user.id).single();if(d){async function e(){const{data:b,error:c}=await supabase.from("dealers").select("token_balance").eq("id",i).single();b?g.textContent=`Your Token Balance: ${b.token_balance||0} tokens`:console.error("Failed to fetch dealer balance:",c.message)}async function a(){const a=[{id:1,time:"11:00 AM",hour:11,minute:0},{id:2,time:"12:30 PM",hour:12,minute:30},{id:3,time:"2:00 PM",hour:14,minute:0},{id:4,time:"3:30 PM",hour:15,minute:30},{id:5,time:"5:00 PM",hour:17,minute:0},{id:6,time:"6:30 PM",hour:18,minute:30},{id:7,time:"8:00 PM",hour:20,minute:0},{id:8,time:"9:00 PM",hour:21,minute:0}];n.innerHTML="";const f=new Date,g=[];if(a.forEach(a=>{const c=new Date(f.getFullYear(),f.getMonth(),f.getDate(),a.hour,a.minute);c>f&&g.push({...a,date:f})}),0===g.length){const b=new Date(f);b.setDate(f.getDate()+1),g.push({...a[0],date:b})}const h=g.find(d=>{const a=new Date(d.date.getFullYear(),d.date.getMonth(),d.date.getDate(),d.hour,d.minute),c=(a.getTime()-f.getTime())/6e4;return 20<c});if(h){const a=document.createElement("option");a.value=h.id;const c=h.date.getDate()!==f.getDate(),d=c?" (Tomorrow)":"";a.textContent=`${h.id}th Baji - ${h.time}${d}`,n.appendChild(a),k.style.display="block",j.style.display="none"}else k.style.display="none",j.style.display="block"}async function f(b){const c=new Date().toISOString().split("T")[0],{data:d,error:e}=await supabase.from("plays").select("*").eq("dealer_id",b).eq("play_date",c).order("baji_slot",{ascending:!0});if(e||!d||0===d.length)return void(l.innerHTML="<p style=\"text-align: center;\">No bets placed today.</p>");const{data:n}=await supabase.from("results").select("*").eq("date",c);l.innerHTML="",d.forEach(c=>{const d=document.createElement("div");d.className="admin-section";const f=n.find(a=>a.slot_id===c.baji_slot),g=f?f.single_number:"-",h=Object.keys(c.played_numbers)[0],i=c.played_numbers[h],k="-"!==g&&parseInt(h)===g,j=k?90*i:0,e=k?"green":"red",a=k?"Congratulations, you won!":"Sorry, you lost.";d.innerHTML=`
                    <h3>${c.baji_slot}th Baji - ${c.play_time}</h3>
                    <p><strong>Your Number:</strong> ${h} (Tokens: ${i})</p>
                    <p><strong>Winning Number:</strong> ${g}</p>
                    <p style="color: ${e}; font-weight: bold;">${a}</p>
                    <p><strong>Prize Tokens:</strong> ${j}</p>
                `,l.appendChild(d)})}m.textContent=`Welcome, ${d.name}!`;const i=d.id;c.addEventListener("click",async()=>{const{error:b}=await supabase.auth.signOut();window.location.href="admin.html"}),k.addEventListener("submit",async g=>{g.preventDefault();const h=parseInt(n.value),a=parseInt(o.value),b=parseInt(p.value);if(isNaN(a)||0>a||9<a||isNaN(b)||0>=b)return q.textContent="Please enter a valid number (0-9) and amount.",void(q.style.color="red");const{error:c}=await supabase.rpc("place_bet",{dealer_id_in:i,baji_slot_in:h,bet_number_in:a.toString(),bet_amount_in:b});return c?(q.textContent="Failed to place bet: "+c.message,void(q.style.color="red")):void(q.textContent="Bet placed successfully!",q.style.color="green",k.reset(),await e(),await f(i))}),e(),a(),f(i),setInterval(()=>{e(),f(i),a()},5e3)}else m.textContent=`Error! Dealer not found.`,console.error("Failed to fetch dealer name:",a.message)}function setupLoginButton(){const b=document.getElementById("login-link");b&&(b.href="admin.html")}async function fetchTodayResults(){const f=new Date().toISOString().split("T")[0],{data:a,error:b}=await supabase.from("results").select("*").eq("date",f).order("slot_id",{ascending:!0});if(b)return void console.error("Error fetching today's results:",b.message);const i=document.querySelector(".today-result .results-grid");i.innerHTML="";const d=new Map;a.forEach(b=>{d.set(b.slot_id,b)});for(let e=1;8>=e;e++){const f=d.get(e),g=f?f.patti_number:"- - -",a=f?f.single_number:"-",b=document.createElement("div");b.className="result-box-item",b.innerHTML=`
            <div class="patti">${g}</div>
            <div class="single">${a}</div>
        `,i.appendChild(b)}document.getElementById("current-date").textContent=new Date().toLocaleDateString("en-US")}async function fetchOldResults(){const{data:a,error:b}=await supabase.from("old_results").select("*").order("date",{ascending:!1}).limit(100);if(b)return void console.error("Error fetching old results:",b.message);const d=a.reduce((d,a)=>{const b=a.date;return d[b]||(d[b]=[]),d[b].push(a),d},{}),e=document.querySelector(".old-results-container");for(const a in e.innerHTML="",d){const b=document.createElement("div");b.className="old-results-day",b.innerHTML=`
            <div class="result-date">${new Date(a).toLocaleDateString("en-US")}</div>
            <div class="results-grid"></div>
        `,e.appendChild(b);const g=b.querySelector(".results-grid"),i=d[a].sort((c,a)=>c.slot_id-a.slot_id);for(let a=1;8>=a;a++){const b=i.find(b=>b.slot_id===a),c=b?b.patti_number:"- - -",d=b?b.single_number:"-",e=document.createElement("div");e.className="result-box-item",e.innerHTML=`
                <div class="patti">${c}</div>
                <div class="single">${d}</div>
            `,g.appendChild(e)}}}function startLiveAnimation(){const b=document.querySelector(".today-result .date-header");b.classList.add("live-animation")}