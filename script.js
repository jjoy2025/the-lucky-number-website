const SUPABASE_URL="https://urjcuxavrkyqttwtqvjx.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ",supabase=window.supabase.createClient("https://urjcuxavrkyqttwtqvjx.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamN1eGF2cmt5cXR0d3Rxdmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDI5NDIsImV4cCI6MjA3MDk3ODk0Mn0._HzIlEtRtwnsssFGonEqrHcqBm9WtXAx7bWa6S-9ErQ");document.addEventListener("DOMContentLoaded",()=>{window.location.pathname.endsWith("admin.html")?setupAdminPanel():window.location.pathname.endsWith("dealer-dashboard.html")?setupDealerDashboard():setupPublicWebsite()});function setupPublicWebsite(){fetchTodayResults(),fetchOldResults(),setupLoginButton(),startLiveAnimation(),supabase.channel("results_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"results"},a=>{console.log("New result added:",a.new),fetchTodayResults()}).subscribe()}async function setupAdminPanel(){async function C(){const{data:b,error:c}=await supabase.from("dealers").select("*");return c?void console.error("Failed to load dealers:",c.message):void(q.innerHTML="<option value=\"\">Select Dealer</option>",b.forEach(b=>{const c=document.createElement("option");c.value=b.id,c.textContent=`${b.name} (${b.token_balance||0} tokens)`,q.appendChild(c)}))}async function D(){const{data:b,error:c}=await supabase.from("dealers").select("id, name");return c?void console.error("Failed to load dealers for report:",c.message):void(r.innerHTML="<option value=\"\">Select Dealer</option>",b.forEach(b=>{const c=document.createElement("option");c.value=b.id,c.textContent=b.name,r.appendChild(c)}))}async function E(d,f){const{data:a,error:b}=await supabase.from("plays").select("*").eq("dealer_id",d).eq("play_date",f);if(b||!a||0===a.length)return void(v.innerHTML="<p>No report found for this date.</p>");const{data:h}=await supabase.from("results").select("*").eq("date",f);v.innerHTML=`<h2>Report for ${f}</h2>`,v.innerHTML+="<table border=\"1\" style=\"width:100%; text-align:center;\">",v.innerHTML+="<thead><tr><th>Time</th><th>Played Numbers</th><th>Winning Number</th><th>Spent</th><th>Prize</th><th>Profit/Loss</th></tr></thead>",v.innerHTML+="<tbody>";let i=0,j=0;a.forEach(e=>{const f=h.find(b=>b.slot_id===e.baji_slot),a=f?f.single_number:"-",b=Object.keys(e.played_numbers).map(b=>`${b}(${e.played_numbers[b]})`).join(", "),c="-"!==a&&e.played_numbers[a]?90*e.played_numbers[a]:0,d=c-e.total_spent_tokens;i+=e.total_spent_tokens,j+=c,v.innerHTML+=`
                <tr>
                    <td>${e.play_time}</td>
                    <td>${b}</td>
                    <td>${a}</td>
                    <td>${e.total_spent_tokens}</td>
                    <td>${c}</td>
                    <td>${d}</td>
                </tr>
            `}),v.innerHTML+=`
            <tr>
                <td colspan="3">Total</td>
                <td>${i}</td>
                <td>${j}</td>
                <td>${j-i}</td>
            </tr>
        `,v.innerHTML+="</tbody></table>",w.innerHTML=""}async function a(f){const{data:g,error:a}=await supabase.from("plays").select("played_numbers").eq("play_date",f);if(a||!g||0===g.length)return w.innerHTML="<p>No data found for this date.</p>",void(z&&z.destroy());const h={};g.forEach(c=>{for(const d in c.played_numbers){const a=c.played_numbers[d];h[d]?h[d]+=a:h[d]=a}});const b=Object.keys(h).sort((a,b)=>a-b),c=b.map(a=>h[a]);z&&z.destroy();const d=document.getElementById("myChart").getContext("2d");z=new Chart(d,{type:"bar",data:{labels:b,datasets:[{label:"Most tokens placed on",data:c,backgroundColor:"rgba(243, 156, 18, 0.7)",borderColor:"rgba(243, 156, 18, 1)",borderWidth:1}]},options:{responsive:!0,scales:{x:{title:{display:!0,text:"Number"}},y:{beginAtZero:!0,title:{display:!0,text:"Tokens"}}}}}),v.innerHTML=""}const{data:{session:c},error:b}=await supabase.auth.getSession(),d=document.getElementById("common-login-form"),e=document.getElementById("login-section"),f=document.getElementById("data-entry-section"),g=document.getElementById("logout-btn"),h=document.getElementById("auth-error"),F=document.getElementById("result-form"),i=document.getElementById("dealer-form"),j=document.getElementById("token-transfer-form"),l=document.getElementById("baji-select"),k=document.querySelectorAll(".tab-button"),m=document.querySelectorAll(".tab-content"),n=document.getElementById("result-message"),o=document.getElementById("dealer-message"),p=document.getElementById("token-message"),q=document.getElementById("dealer-select"),r=document.getElementById("report-dealer-select"),s=document.getElementById("report-date-input"),t=document.getElementById("showReportBtn"),u=document.getElementById("showGraphBtn"),v=document.getElementById("reportContainer"),w=document.getElementById("graphContainer"),x=document.getElementById("archive-btn"),y=document.getElementById("archive-message");let z=null;(function a(){l.innerHTML="";for(let b=1;8>=b;b++){const c=document.createElement("option");c.value=b,c.textContent=`Baji ${b}`,l.appendChild(c)}})(),c?(e.style.display="none",f.style.display="block",g.style.display="block",await C(),await D()):(e.style.display="block",f.style.display="none",g.style.display="none"),k.forEach(b=>{b.addEventListener("click",()=>{k.forEach(a=>a.classList.remove("active")),m.forEach(a=>a.classList.remove("active")),b.classList.add("active");const c=b.dataset.tab;document.getElementById(c).classList.add("active"),z&&(z.destroy(),z=null)})}),d.addEventListener("submit",async f=>{f.preventDefault();const g=document.getElementById("email-input").value,a=document.getElementById("password-input").value;h.textContent="";const{data:b,error:c}=await supabase.auth.signInWithPassword({email:g,password:a});if(c)return void(h.textContent="Login failed: "+c.message);const{data:{user:d}}=await supabase.auth.getUser();if(d){const{data:b,error:c}=await supabase.from("dealers").select("id").eq("user_id",d.id).single();window.location.href=b?`dealer-dashboard.html?dealerId=${b.id}`:"admin.html"}}),F.addEventListener("submit",async g=>{g.preventDefault();const h=document.getElementById("date-input").value,a=parseInt(l.value),b=document.getElementById("patti-input").value,c=parseInt(document.getElementById("single-input").value),d=new Date().toISOString().split("T")[0];let e=null;e=h===d?"results":"old_results";const{error:i}=await supabase.from(e).upsert({date:h,slot_id:a,patti_number:b,single_number:c});i?(n.textContent="Failed to save result: "+i.message,n.style.color="red"):(n.textContent="Result saved successfully!",n.style.color="green",F.reset(),h===d?fetchTodayResults():fetchOldResults())}),i.addEventListener("submit",async a=>{a.preventDefault();const c=document.getElementById("dealer-name").value,g=document.getElementById("dealer-phone").value,d=document.getElementById("dealer-password").value,e=document.getElementById("dealer-message");e.textContent="Adding dealer...",e.className="message";try{const{error:a}=await supabase.rpc("create_dealer",{dealer_name:c,dealer_phone:g,dealer_password:d});if(a)throw a;e.textContent="Dealer added successfully!",e.className="message success-message",document.getElementById("dealer-form").reset(),await C(),await D()}catch(a){e.textContent=`Failed to add dealer: ${a.message}`,e.className="message error-message",console.error("Error adding dealer:",a)}}),j.addEventListener("submit",async f=>{f.preventDefault();const a=document.getElementById("dealer-select").value,b=parseInt(document.getElementById("token-amount").value);if(!a||isNaN(b)||0>=b)return p.textContent="Please enter a valid amount and select a dealer.",void(p.style.color="red");const{data:c,error:d}=await supabase.rpc("transfer_tokens_secure",{dealer_id_in:a,amount_in:b});d?(p.textContent="Failed to transfer tokens: "+d.message,p.style.color="red",console.error("Database function call failed:",d)):(p.textContent="Tokens transferred successfully!",p.style.color="green",j.reset(),await C())}),x&&x.addEventListener("click",async()=>{y.textContent="Archiving...";const{error:a}=await supabase.rpc("archive_daily_results");a?(y.textContent="Archiving failed: "+a.message,y.style.color="red"):(y.textContent="Previous day's results archived successfully!",y.style.color="green",fetchTodayResults(),fetchOldResults())}),t.addEventListener("click",()=>{const b=r.value,c=s.value;b&&c?E(b,c):alert("Please select a dealer and a date.")}),u.addEventListener("click",()=>{const b=s.value;b?a(b):alert("Please select a date.")}),g.addEventListener("click",async()=>{const{error:a}=await supabase.auth.signOut();window.location.reload()})}async function setupDealerDashboard(){const{data:{session:l},error:k}=await supabase.auth.getSession();if(!l)return void(window.location.href="admin.html");const n=document.getElementById("dealer-name-display"),o=document.getElementById("current-token-balance"),c=document.getElementById("logout-btn"),p=document.getElementById("betting-form"),q=document.getElementById("bet-number"),f=document.getElementById("bet-amount"),g=document.getElementById("bet-message"),m=document.getElementById("slips-container"),h=document.getElementById("baji-select"),d=document.getElementById("betting-closed-message"),{data:i,error:a}=await supabase.from("dealers").select("id, name").eq("user_id",l.user.id).single();if(i){async function j(){const{data:b,error:c}=await supabase.from("dealers").select("token_balance").eq("id",l).single();b?o.textContent=`Your Token Balance: ${b.token_balance||0} tokens`:console.error("Failed to fetch dealer balance:",c.message)}async function b(){const c=[{id:1,time:"11:00 AM",hour:11,minute:0},{id:2,time:"12:30 PM",hour:12,minute:30},{id:3,time:"2:00 PM",hour:14,minute:0},{id:4,time:"3:30 PM",hour:15,minute:30},{id:5,time:"5:00 PM",hour:17,minute:0},{id:6,time:"6:30 PM",hour:18,minute:30},{id:7,time:"8:00 PM",hour:20,minute:0},{id:8,time:"9:00 PM",hour:21,minute:0}];h.innerHTML="";const e=new Date,f=[];if(c.forEach(b=>{const c=new Date(e.getFullYear(),e.getMonth(),e.getDate(),b.hour,b.minute);c>e&&f.push({...b,date:e})}),0===f.length){const b=new Date(e);b.setDate(e.getDate()+1),f.push({...c[0],date:b})}const i=f.find(d=>{const b=new Date(d.date.getFullYear(),d.date.getMonth(),d.date.getDate(),d.hour,d.minute),a=(b.getTime()-e.getTime())/6e4;return 20<a});if(i){const f=document.createElement("option");f.value=i.id;const b=i.date.getDate()!==e.getDate(),a=b?" (Tomorrow)":"";f.textContent=`${i.id}th Baji - ${i.time}${a}`,h.appendChild(f),p.style.display="block",d.style.display="none"}else p.style.display="none",d.style.display="block"}async function k(d){const e=new Date().toISOString().split("T")[0],{data:a,error:b}=await supabase.from("plays").select("*").eq("dealer_id",d).eq("play_date",e).order("baji_slot",{ascending:!0});if(b||!a||0===a.length)return void(m.innerHTML="<p style=\"text-align: center;\">No bets placed today.</p>");const{data:l}=await supabase.from("results").select("*").eq("date",e);m.innerHTML="",a.forEach(j=>{const e=document.createElement("div");e.className="admin-section";const a=l.find(b=>b.slot_id===j.baji_slot),b=a?a.single_number:"-",c=Object.keys(j.played_numbers)[0],d=j.played_numbers[c],f="-"!==b&&parseInt(c)===b,g=f?90*d:0,h=f?"green":"red",i=f?"Congratulations, you won!":"Sorry, you lost.";e.innerHTML=`
                    <h3>${j.baji_slot}th Baji - ${j.play_time}</h3>
                    <p><strong>Your Number:</strong> ${c} (Tokens: ${d})</p>
                    <p><strong>Winning Number:</strong> ${b}</p>
                    <p style="color: ${h}; font-weight: bold;">${i}</p>
                    <p><strong>Prize Tokens:</strong> ${g}</p>
                `,m.appendChild(e)})}n.textContent=`Welcome, ${i.name}!`;const l=i.id;c.addEventListener("click",async()=>{const{error:a}=await supabase.auth.signOut();window.location.href="admin.html"}),p.addEventListener("submit",async i=>{i.preventDefault();const a=parseInt(h.value),b=parseInt(q.value),c=parseInt(f.value);if(isNaN(b)||0>b||9<b||isNaN(c)||0>=c)return g.textContent="Please enter a valid number (0-9) and amount.",void(g.style.color="red");const{error:d}=await supabase.rpc("place_bet",{dealer_id_in:l,baji_slot_in:a,bet_number_in:b.toString(),bet_amount_in:c});return d?(g.textContent="Failed to place bet: "+d.message,void(g.style.color="red")):void(g.textContent="Bet placed successfully!",g.style.color="green",p.reset(),await j(),await k(l))}),j(),b(),k(l),setInterval(()=>{j(),k(l),b()},5e3)}else n.textContent=`Error! Dealer not found.`,console.error("Failed to fetch dealer name:",a.message)}function setupLoginButton(){const a=document.getElementById("login-link");a&&(a.href="admin.html")}async function fetchTodayResults(){const c=new Date().toISOString().split("T")[0],{data:e,error:a}=await supabase.from("results").select("*").eq("date",c).order("slot_id",{ascending:!0});if(a)return void console.error("Error fetching today's results:",a.message);const g=document.querySelector(".today-result .results-grid");g.innerHTML="";const h=new Map;e.forEach(a=>{h.set(a.slot_id,a)});for(let d=1;8>=d;d++){const e=h.get(d),a=e?e.patti_number:"- - -",b=e?e.single_number:"-",c=document.createElement("div");c.className="result-box-item",c.innerHTML=`
            <div class="patti">${a}</div>
            <div class="single">${b}</div>
        `,g.appendChild(c)}document.getElementById("current-date").textContent=new Date().toLocaleDateString("en-US")}async function fetchOldResults(){const{data:b,error:d}=await supabase.from("old_results").select("*").order("date",{ascending:!1}).limit(100);if(d)return void console.error("Error fetching old results:",d.message);const f=b.reduce((c,d)=>{const a=d.date;return c[a]||(c[a]=[]),c[a].push(d),c},{}),g=document.querySelector(".old-results-container");for(const b in g.innerHTML="",f){const c=document.createElement("div");c.className="old-results-day",c.innerHTML=`
            <div class="result-date">${new Date(b).toLocaleDateString("en-US")}</div>
            <div class="results-grid"></div>
        `,g.appendChild(c);const i=c.querySelector(".results-grid"),h=f[b].sort((a,b)=>a.slot_id-b.slot_id);for(let b=1;8>=b;b++){const c=h.find(c=>c.slot_id===b),a=c?c.patti_number:"- - -",e=c?c.single_number:"-",f=document.createElement("div");f.className="result-box-item",f.innerHTML=`
                <div class="patti">${a}</div>
                <div class="single">${e}</div>
            `,i.appendChild(f)}}}function startLiveAnimation(){const a=document.querySelector(".today-result .date-header");a.classList.add("live-animation")}